FROM node:20.11.1-alpine3.19@sha256:f4c96a28c0b2d8981664e03f461c2677152cd9a756012ffa8e2c6727427c2bda

LABEL maintainer="juancarlosjr97@gmail.com" \
    description="This is a build container image to deploy Next.js web app using SSR"

ENV NEXT_TELEMETRY_DISABLED 1
ENV PORT 3000

ARG DATABASE_URL
ARG DATABASE_URL_PRISMA
ARG ENVIRONMENT
ARG NEXT_PUBLIC_LOGICAL_ENVIRONMENT
ARG NEXT_PUBLIC_SENTRY_DSN
ARG NEXT_PUBLIC_URL
ARG NEXTAUTH_SECRET
ARG NEXTAUTH_URL
ARG SENTRY_AUTH_TOKEN
ARG SENTRY_DSN
ARG SENTRY_SECURITY_HEADER_ENDPOINT
ARG SMTP_FROM
ARG SMTP_HOST
ARG SMTP_PASSWORD
ARG SMTP_PORT
ARG SMTP_SECURE
ARG SMTP_USER

ENV DATABASE_URL_PRISMA={DATABASE_URL_PRISMA}
ENV DATABASE_URL=${DATABASE_URL}
ENV ENVIRONMENT=${ENVIRONMENT}
ENV NEXT_PUBLIC_LOGICAL_ENVIRONMENT=${NEXT_PUBLIC_LOGICAL_ENVIRONMENT}
ENV NEXT_PUBLIC_SENTRY_DSN=${NEXT_PUBLIC_SENTRY_DSN}
ENV NEXT_PUBLIC_URL=${NEXT_PUBLIC_URL}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}
ENV SENTRY_DSN=${SENTRY_DSN}
ENV SENTRY_SECURITY_HEADER_ENDPOINT=${SENTRY_SECURITY_HEADER_ENDPOINT}
ENV SMTP_FROM=${SMTP_FROM}
ENV SMTP_HOST=${SMTP_HOST}
ENV SMTP_PASSWORD=${SMTP_PASSWORD}
ENV SMTP_PORT=${SMTP_PORT}
ENV SMTP_SECURE=${SMTP_SECURE}
ENV SMTP_USER=${SMTP_USER}

WORKDIR /app

COPY . ./

RUN yarn config set network-timeout 300000

RUN yarn install --frozen-lockfile \
    && yarn build:next \
    && rm -rf node_modules \
    && yarn install --production --prefer-offline \
    && yarn cache clean --all

RUN chmod +x scripts/start.sh

EXPOSE 3000

CMD scripts/start.sh

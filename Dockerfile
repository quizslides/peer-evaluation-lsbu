FROM docker.io/library/node:20.16.0-alpine3.20@sha256:eb8101caae9ac02229bd64c024919fe3d4504ff7f329da79ca60a04db08cef52

LABEL maintainer="juancarlosjr97@gmail.com" \
    description="This is a build container image to deploy Next.js web app using SSR"

ENV NEXT_TELEMETRY_DISABLED 1
ENV PORT 3000

ARG DATABASE_URL
ARG DATABASE_URL_PRISMA
ARG ENVIRONMENT
ARG NEXT_PUBLIC_LOGICAL_ENVIRONMENT
ARG NEXT_PUBLIC_SENTRY_DSN
ARG NEXT_PUBLIC_URL
ARG NEXTAUTH_SECRET
ARG NEXTAUTH_URL
ARG SENTRY_AUTH_TOKEN
ARG SENTRY_DSN
ARG SENTRY_SECURITY_HEADER_ENDPOINT
ARG SMTP_FROM
ARG SMTP_HOST
ARG SMTP_PASSWORD
ARG SMTP_PORT
ARG SMTP_SECURE
ARG SMTP_USER

ENV DATABASE_URL_PRISMA={DATABASE_URL_PRISMA}
ENV DATABASE_URL=${DATABASE_URL}
ENV ENVIRONMENT=${ENVIRONMENT}
ENV NEXT_PUBLIC_LOGICAL_ENVIRONMENT=${NEXT_PUBLIC_LOGICAL_ENVIRONMENT}
ENV NEXT_PUBLIC_SENTRY_DSN=${NEXT_PUBLIC_SENTRY_DSN}
ENV NEXT_PUBLIC_URL=${NEXT_PUBLIC_URL}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}
ENV SENTRY_DSN=${SENTRY_DSN}
ENV SENTRY_SECURITY_HEADER_ENDPOINT=${SENTRY_SECURITY_HEADER_ENDPOINT}
ENV SMTP_FROM=${SMTP_FROM}
ENV SMTP_HOST=${SMTP_HOST}
ENV SMTP_PASSWORD=${SMTP_PASSWORD}
ENV SMTP_PORT=${SMTP_PORT}
ENV SMTP_SECURE=${SMTP_SECURE}
ENV SMTP_USER=${SMTP_USER}

WORKDIR /app

USER root

COPY --chown=node . ./

RUN npm ci --legacy-peer-deps \
    && npm run build:next \
    && npm ci --legacy-peer-deps --omit=dev

RUN chmod +x scripts/start.sh

EXPOSE 3000

USER node

CMD ["scripts/start.sh"]
